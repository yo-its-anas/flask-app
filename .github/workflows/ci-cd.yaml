name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to Dockerhub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build & push to docker
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: anaslinux/flask-app:latest

    deploy:
      needs: build-and-push
      runs-on: ubuntu-latest

      steps:
        - name: Deploy to EC2 server
          uses: appleboy/ssh-action
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_SSH_KEY }}
            script: |
              cd /home/ubuntu

              if [ ! -d "flask-app"]; then
                git clone https://github.com/yo-its-anas/flask-app.git
              fi

              cd flask-app
              git pull origin main

              docker pull anaslinux/flask-app:latest
              docker-compose down
              docker-compose up -d
